<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Editor de Partitura</title>
    <style>
        .partitura {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 20px;
            background-color: #fff;
            min-height: 200px;
            border: 1px solid #ccc;
        }

        .compas {
            min-width: 200px;
            height: auto;
            min-height: 120px;
            border: 2px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            position: relative;
            cursor: pointer;
            padding: 20px 15px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .controles {
            margin: 20px;
        }

        button {
            font-size: 20px;
            margin: 0 10px;
            padding: 5px 15px;
            cursor: pointer;
        }

        .numero-compas {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 12px;
            color: #666;
        }

        .acordes,
        .letras {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            min-height: 50px;
            padding: 5px;
            width: 100%;
        }

        .contenedor-acorde-letra {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .acorde,
        .letra {
            min-width: 80px;
            width: auto;
            height: auto;
            min-height: 50px;
            padding: 5px 10px;
            border: 1px solid transparent;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            transition: all 0.3s ease;
            background-color: white;
            word-break: break-word;
        }

        .letra {
            border: 1px dashed #ccc;
            /* Borde punteado para diferenciar */
            color: #666;
            /* Color m√°s suave para las letras */
        }

        .acorde.nuevo,
        .letra.nuevo {
            color: #666;
        }

        .acorde.escrito {
            color: #2ecc71;
        }

        .letra.escrito {
            color: #3498db;
            /* Color diferente para letras escritas */
        }

        .acorde.seleccionado,
        .letra.seleccionado {
            background-color: #3498db;
            color: white;
        }

        .acorde:hover .eliminar-acorde,
        .letra:hover .eliminar-letra {
            display: block;
        }

        .eliminar-acorde,
        .eliminar-letra,
        .eliminar-compas {
            display: none;
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            line-height: 20px;
            cursor: pointer;
            text-align: center;
            z-index: 10;
        }

        .compas:hover .eliminar-compas {
            display: block;
        }

        .acorde-input,
        .letra-input {
            min-width: 80px;
            width: auto;
            height: auto;
            min-height: 50px;
            font-size: 24px;
            text-align: center;
            border: 1px solid #999;
            padding: 5px 10px;
            box-sizing: border-box;
        }

        .agregar-acorde-btn {
            position: absolute;
            /* Cambiado a posici√≥n absoluta */
            right: -15px;
            /* Posicionado a la derecha */
            top: 50%;
            /* Centrado verticalmente */
            transform: translateY(-50%);
            /* Ajuste fino del centrado vertical */
            width: 30px;
            height: 30px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agregar-acorde-btn:hover {
            background-color: #27ae60;
        }

        .compas.arrastrando,
        .acorde.arrastrando,
        .letra.arrastrando {
            opacity: 0.5;
            cursor: move;
        }

        .compas.drop-izquierda {
            border-left: 3px solid #3498db;
        }

        .compas.drop-derecha {
            border-right: 3px solid #3498db;
        }

        .acorde.drop-izquierda,
        .letra.drop-izquierda {
            border-left: 3px solid #3498db;
        }

        .acorde.drop-derecha,
        .letra.drop-derecha {
            border-right: 3px solid #3498db;
        }

        .acordes.drop-activo,
        .letras.drop-activo {
            background-color: #f0f9ff;
            border: 2px dashed #3498db;
        }

        .contenedor-compas {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: relative;
            /* A√±adido para posicionamiento relativo */
        }

        .json-output {
            margin: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .json-container {
            margin: 20px;
        }

        .json-container button {
            margin-bottom: 10px;
        }

        /* Agregar al CSS existente */
        .container {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: 100vh;
        }

        .imagenes-container {
            width: 300px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
        }

        .imagenes-scroll {
            height: calc(100vh - 100px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
        }

        .imagen-compas {
            position: relative;
            width: 100%;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
        }

        .imagen-compas img {
            width: 100%;
            height: auto;
            display: block;
        }

        .imagen-compas .numero-compas {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .imagen-upload {
            width: 100%;
            padding: 20px;
            border: 2px dashed #ccc;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .imagen-upload:hover {
            border-color: #3498db;
            background: #f7f9fc;
        }

        .eliminar-imagen {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
        }

        #images-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        /* ... existing styles ... */
        .nombre-compas {
            position: absolute;
            top: 2px;
            right: 25px;
            /* Espacio para no solapar con el bot√≥n de eliminar */
            font-size: 12px;
            color: #666;
            cursor: pointer;
            padding: 2px 5px;
            border: 1px dashed transparent;
        }

        .nombre-compas:hover {
            border-color: #ccc;
        }

        .nombre-compas-input {
            position: absolute;
            top: 2px;
            right: 25px;
            font-size: 12px;
            padding: 2px 5px;
            border: 1px solid #999;
        }


        /* ... existing styles ... */
        .compas.seleccionado {
            background-color: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .imagen-compas.seleccionado {
            background-color: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        #map {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .map-container {
            position: relative;
            margin: 20px 0;
        }

        #ubicar-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none; /* Se mostrar√° cuando se seleccione un comp√°s */
        }

        #ubicar-btn:hover {
            background-color: #27ae60;
        }

        /* Agregar estos estilos */
        .json-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .json-column h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .json-output {
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
    <div class="container">
        <!-- Nuevo contenedor para im√°genes -->
        <div class="imagenes-container">
            <h3>Im√°genes</h3>
            <div class="controles">
                <button onclick="agregarContenedorImagen()">+</button>
            </div>
            <div class="imagenes-scroll" id="imagenes-scroll">
                <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Contenedor principal derecho -->
        <div class="main-content">
            <div class="controles">
                <button onclick="agregarCompas()">+</button>
                <button onclick="eliminarCompas()">-</button>
            </div>
            <div class="partitura" id="partitura">
            </div>
            <div class="json-container">
                <div class="json-grid">
                    <div class="json-column">
                        <h4>Partitura Completa</h4>
                        <div id="json-output" class="json-output"></div>
                    </div>
                    <div class="json-column">
                        <h4>Compases Seleccionados</h4>
                        <div id="json-seleccionados" class="json-output"></div>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
                <button id="ubicar-btn" style="display: none;">Ubicar</button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        let contadorCompases = 0;
        let acordeSeleccionado = null;
        let letraSeleccionada = null;
        let elementoArrastrado = null;
        let compasSeleccionado = null;
        let compasesSeleccionados = new Set();

        let map, marker;
        let currentCenter;

        // Agregar estas variables globales
        let ultimoEstadoJSON = '';
        let timerAutoguardado = null;
        let cambiosPendientes = false;

        // Funci√≥n para comparar si hay cambios
        function hayCambios() {
            const estadoActual = generarJSONEstado();
            return estadoActual !== ultimoEstadoJSON;
        }

        // Funci√≥n para generar el estado actual en JSON
        function generarJSONEstado() {
            const partitura = document.getElementById('partitura');
            const estado = {
                compases: []
            };

            partitura.querySelectorAll('.compas').forEach((compas, index) => {
                const numeroCompas = index + 1;
                const nombreCompas = compas.querySelector('.nombre-compas')?.textContent || 'Sin t√≠tulo';
                const imagenId = compas.getAttribute('data-imagen-id');
                const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"] img`);
                
                estado.compases.push({
                    numero: numeroCompas,
                    nombre: nombreCompas,
                    imagen: contenedorImagen ? contenedorImagen.src : null,
                    lat: compas.getAttribute('data-lat'),
                    lng: compas.getAttribute('data-lng')
                });
            });

            return JSON.stringify(estado);
        }

        // Funci√≥n de autoguardado
        async function autoguardar() {
            if (!cambiosPendientes || !hayCambios()) {
                return;
            }

            const estado = generarJSONEstado();
            ultimoEstadoJSON = estado;
            cambiosPendientes = false;
            
            // Actualizar la visualizaci√≥n del JSON
            const jsonOutput = document.getElementById('json-output');
            if (jsonOutput) {
                jsonOutput.textContent = JSON.stringify(JSON.parse(estado), null, 2);
            }
            
            console.log('‚úÖ Autoguardado completado:', new Date().toLocaleTimeString());
        }

        // Funci√≥n para iniciar el sistema de autoguardado
        function iniciarAutoguardado() {
            // Guardar estado inicial
            ultimoEstadoJSON = generarJSONEstado();
            
            // Configurar el timer de autoguardado
            timerAutoguardado = setInterval(() => {
                autoguardar();
            }, 2000); // Cada 2 segundos

            // Agregar listener para cambios en la partitura
            const partitura = document.getElementById('partitura');
            const observer = new MutationObserver(() => {
                cambiosPendientes = true;
            });

            observer.observe(partitura, {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el mapa
            map = L.map('map').setView([40.416775, -3.703790], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const ubicarBtn = document.getElementById('ubicar-btn');
            
            map.on('move', () => {
                currentCenter = map.getCenter();
                if (marker) {
                    marker.setLatLng(currentCenter);
                }
            });

            ubicarBtn.addEventListener('click', () => {
                console.log('üéØ Click en bot√≥n ubicar');
                if (compasSeleccionado && currentCenter) {
                    // Obtener las coordenadas actuales
                    const lat = currentCenter.lat.toFixed(6);  // Redondear a 6 decimales
                    const lng = currentCenter.lng.toFixed(6);

                    console.log('üìç Coordenadas actuales:', {
                        latitud: lat,
                        longitud: lng
                    });
                    
                    // Guardar las coordenadas en el comp√°s
                    compasSeleccionado.setAttribute('data-lat', lat);
                    compasSeleccionado.setAttribute('data-lng', lng);
                    
                    // Mostrar las coordenadas guardadas
                    console.log('üíæ Coordenadas guardadas en el comp√°s:', {
                        latitud: compasSeleccionado.getAttribute('data-lat'),
                        longitud: compasSeleccionado.getAttribute('data-lng')
                    });

                    // Actualizar el JSON y mostrar confirmaci√≥n
                    actualizarJSON();
                    console.log('‚úÖ JSON actualizado con las nuevas coordenadas');
                } else {
                    console.warn('‚ö†Ô∏è No hay comp√°s seleccionado o coordenadas no disponibles');
                }
            });

            // Configurar el observer aqu√≠
            const observer = new MutationObserver(() => {
                actualizarJSON();
            });

            observer.observe(document.getElementById('partitura'), {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true
            });

            iniciarAutoguardado();
        });

        function agregarCompas() {
            contadorCompases++;
            const partitura = document.getElementById('partitura');
            const nuevoCompas = document.createElement('div');
            nuevoCompas.className = 'compas';
            nuevoCompas.draggable = true;
            
            nuevoCompas.addEventListener('dragstart', dragStart);
            nuevoCompas.addEventListener('dragend', dragEnd);
            nuevoCompas.addEventListener('dragover', dragOver);
            nuevoCompas.addEventListener('drop', drop);

            const eliminarCompasBtn = document.createElement('div');
            eliminarCompasBtn.className = 'eliminar-compas';
            eliminarCompasBtn.textContent = '√ó';
            eliminarCompasBtn.onclick = (e) => {
                e.stopPropagation();
                partitura.removeChild(nuevoCompas);
                actualizarNumerosCompases();
            };

            const numeroCompas = document.createElement('div');
            numeroCompas.className = 'numero-compas';
            numeroCompas.textContent = contadorCompases;

            const nombreCompas = document.createElement('div');
            nombreCompas.className = 'nombre-compas';
            nombreCompas.textContent = 'Sin t√≠tulo';
            nombreCompas.onclick = function (e) {
                e.stopPropagation();
                const input = document.createElement('input');
                input.className = 'nombre-compas-input';
                input.value = nombreCompas.textContent;

                input.onblur = function () {
                    const nuevoNombre = input.value || 'Sin t√≠tulo';
                    nombreCompas.textContent = nuevoNombre;
                    nuevoCompas.replaceChild(nombreCompas, input);

                    // Actualizar el nombre en el contenedor de imagen si existe
                    const imagenId = nuevoCompas.getAttribute('data-imagen-id');
                    if (imagenId) {
                        const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"]`);
                        if (contenedorImagen) {
                            const nombreImagen = contenedorImagen.querySelector('.nombre-imagen');
                            if (nombreImagen) {
                                nombreImagen.textContent = nuevoNombre;
                            }
                        }
                    }
                    actualizarJSON();
                };

                input.onkeypress = function (e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                };

                nuevoCompas.replaceChild(input, nombreCompas);
                input.focus();
            };

            const acordesDiv = document.createElement('div');
            acordesDiv.className = 'acordes';

            acordesDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                acordesDiv.classList.add('drop-activo');
            });

            acordesDiv.addEventListener('dragleave', (e) => {
                acordesDiv.classList.remove('drop-activo');
            });

            acordesDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                acordesDiv.classList.remove('drop-activo');

                if (elementoArrastrado && elementoArrastrado.classList.contains('contenedor-acorde-letra')) {
                    const acordeDestino = e.target.closest('.contenedor-acorde-letra');
                    if (acordeDestino) {
                        const rect = acordeDestino.getBoundingClientRect();
                        const mitad = (rect.left + rect.right) / 2;
                        if (e.clientX < mitad) {
                            acordesDiv.insertBefore(elementoArrastrado, acordeDestino);
                        } else {
                            acordesDiv.insertBefore(elementoArrastrado, acordeDestino.nextSibling);
                        }
                    } else {
                        acordesDiv.appendChild(elementoArrastrado);
                    }
                }
            });

            const contenedorCompas = document.createElement('div');
            contenedorCompas.className = 'contenedor-compas';

            const agregarAcordeBtn = document.createElement('button');
            agregarAcordeBtn.className = 'agregar-acorde-btn';
            agregarAcordeBtn.textContent = '+';
            agregarAcordeBtn.onclick = (e) => {
                e.stopPropagation();
                agregarAcordeYLetra(acordesDiv);
            };

            agregarAcordeYLetra(acordesDiv);

            contenedorCompas.appendChild(acordesDiv);
            contenedorCompas.appendChild(agregarAcordeBtn);

            nuevoCompas.appendChild(eliminarCompasBtn);
            nuevoCompas.appendChild(numeroCompas);
            nuevoCompas.appendChild(nombreCompas);
            nuevoCompas.appendChild(contenedorCompas);
            partitura.appendChild(nuevoCompas);

            nuevoCompas.addEventListener('click', (e) => {
                e.stopPropagation();
                seleccionarCompas(nuevoCompas);
            });

            cambiosPendientes = true;
        }

        // Agregar variable global para contar im√°genes
        let contadorImagenes = 0;

        function agregarContenedorImagen() {
            const imagenesScroll = document.getElementById('imagenes-scroll');
            contadorImagenes++;
            const imagenId = `imagen-${contadorImagenes}`; 
            const nombreImagen = `Imagen ${contadorImagenes}`;
            
            const contenedor = document.createElement('div');
            contenedor.className = 'imagen-compas';
            contenedor.setAttribute('data-imagen-id', imagenId);
            contenedor.setAttribute('data-imagen-nombre', nombreImagen);

            const numeroLabel = document.createElement('div');
            numeroLabel.className = 'numero-compas';
            numeroLabel.innerHTML = `<span class="indice-imagen">${nombreImagen}</span>`;

            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'imagen-upload';
            uploadDiv.textContent = 'Haga clic o arrastre una imagen aqu√≠';

            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.jpg,.jpeg,.svg';
            input.style.display = 'none';

            uploadDiv.onclick = (e) => {
                e.preventDefault();
                input.click();
            };

            input.onchange = function(e) {
                const file = e.target.files[0];
                if (file) {
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(file);
                    
                    // Asignar la imagen a todos los compases seleccionados
                    compasesSeleccionados.forEach(compas => {
                        // Obtener o crear el array de im√°genes
                        let imagenes = compas.getAttribute('data-imagenes');
                        imagenes = imagenes ? JSON.parse(imagenes) : [];
                        
                        // Agregar la nueva imagen
                        imagenes.push({
                            id: imagenId,
                            nombre: nombreImagen
                        });
                        
                        // Guardar el array actualizado
                        compas.setAttribute('data-imagenes', JSON.stringify(imagenes));
                    });

                    if (uploadDiv.parentNode) {
                        contenedor.replaceChild(img, uploadDiv);
                    }
                    
                    actualizarJSON();
                }
            };

            const eliminarBtn = document.createElement('div');
            eliminarBtn.className = 'eliminar-imagen';
            eliminarBtn.textContent = '√ó';
            eliminarBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                // Eliminar la referencia de la imagen en todos los compases que la usan
                document.querySelectorAll('.compas').forEach(compas => {
                    let imagenes = compas.getAttribute('data-imagenes');
                    if (imagenes) {
                        imagenes = JSON.parse(imagenes);
                        imagenes = imagenes.filter(img => img.id !== imagenId);
                        compas.setAttribute('data-imagenes', JSON.stringify(imagenes));
                    }
                });
                contenedor.remove();
                actualizarJSON();
            };

            contenedor.appendChild(numeroLabel);
            contenedor.appendChild(uploadDiv);
            contenedor.appendChild(input);
            contenedor.appendChild(eliminarBtn);
            
            imagenesScroll.appendChild(contenedor);
            return contenedor;
        }

        function agregarAcordeYLetra(acordesDiv) {
            const contenedor = document.createElement('div');
            contenedor.className = 'contenedor-acorde-letra';
            contenedor.draggable = true;

            contenedor.addEventListener('dragstart', (e) => {
                elementoArrastrado = contenedor;
                contenedor.classList.add('arrastrando');
                e.stopPropagation();
            });

            contenedor.addEventListener('dragend', (e) => {
                contenedor.classList.remove('arrastrando');
                elementoArrastrado = null;
                document.querySelectorAll('.drop-activo').forEach(el => el.classList.remove('drop-activo'));
            });

            // Crear acorde
            const acorde = crearElementoEditable('acorde', '%');

            // Crear letra
            const letra = crearElementoEditable('letra', '');

            contenedor.appendChild(acorde);
            contenedor.appendChild(letra);
            acordesDiv.appendChild(contenedor);
        }

        function crearElementoEditable(tipo, textoInicial) {
            const elemento = document.createElement('div');
            elemento.className = `${tipo} nuevo`;

            const contenido = document.createElement('span');
            contenido.textContent = textoInicial;
            elemento.appendChild(contenido);

            const eliminarBtn = document.createElement('div');
            eliminarBtn.className = `eliminar-${tipo}`;
            eliminarBtn.textContent = '√ó';
            eliminarBtn.onclick = (e) => {
                e.stopPropagation();
                const contenedor = elemento.parentElement;
                const acordesDiv = contenedor.parentElement;
                acordesDiv.removeChild(contenedor);
                actualizarJSON();
            };

            elemento.addEventListener('click', function (e) {
                e.stopPropagation();
                if (tipo === 'acorde' && acordeSeleccionado) {
                    acordeSeleccionado.classList.remove('seleccionado');
                } else if (tipo === 'letra' && letraSeleccionada) {
                    letraSeleccionada.classList.remove('seleccionado');
                }

                elemento.classList.add('seleccionado');
                if (tipo === 'acorde') acordeSeleccionado = elemento;
                else letraSeleccionada = elemento;

                const input = document.createElement('input');
                input.className = `${tipo}-input`;
                input.value = contenido.textContent === '%' ? '' : contenido.textContent;

                input.addEventListener('blur', function () {
                    if (input.value.trim()) {
                        contenido.textContent = input.value.trim();
                        elemento.replaceChild(contenido, input);
                        elemento.classList.remove('nuevo');
                        elemento.classList.add('escrito');
                        if (!elemento.contains(eliminarBtn)) {
                            elemento.appendChild(eliminarBtn);
                        }
                    } else {
                        contenido.textContent = tipo === 'acorde' ? '%' : '';
                        elemento.replaceChild(contenido, input);
                        elemento.classList.add('nuevo');
                        elemento.classList.remove('escrito');
                    }
                    elemento.classList.remove('seleccionado');
                    if (tipo === 'acorde') acordeSeleccionado = null;
                    else letraSeleccionada = null;
                    actualizarJSON();
                });

                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });

                if (elemento.contains(contenido)) {
                    elemento.replaceChild(input, contenido);
                } else {
                    elemento.innerHTML = '';
                    elemento.appendChild(input);
                }
                input.focus();
            });

            return elemento;
        }

        function dragStart(e) {
            elementoArrastrado = this;
            this.classList.add('arrastrando');
            e.dataTransfer.setData('type', 'compas');
        }

        function dragEnd(e) {
            this.classList.remove('arrastrando');
            elementoArrastrado = null;
            document.querySelectorAll('.drop-activo').forEach(el => el.classList.remove('drop-activo'));
        }

        function dragOver(e) {
            e.preventDefault();
            const compasDestino = this;
            if (compasDestino !== elementoArrastrado) {
                const rect = compasDestino.getBoundingClientRect();
                const mitad = (rect.left + rect.right) / 2;
                compasDestino.classList.remove('drop-izquierda', 'drop-derecha');
                if (e.clientX < mitad) {
                    compasDestino.classList.add('drop-izquierda');
                } else {
                    compasDestino.classList.add('drop-derecha');
                }
            }
        }

        function drop(e) {
            e.preventDefault();
            const compasDestino = this;
            if (elementoArrastrado && compasDestino !== elementoArrastrado) {
                const rect = compasDestino.getBoundingClientRect();
                const mitad = (rect.left + rect.right) / 2;

                // Obtener los n√∫meros de comp√°s antes del movimiento
                const numeroOrigen = elementoArrastrado.querySelector('.numero-compas').textContent;
                const numeroDestino = compasDestino.querySelector('.numero-compas').textContent;

                if (e.clientX < mitad) {
                    compasDestino.parentNode.insertBefore(elementoArrastrado, compasDestino);
                } else {
                    compasDestino.parentNode.insertBefore(elementoArrastrado, compasDestino.nextSibling);
                }

                // Reordenar las im√°genes
                reordenarImagenes(numeroOrigen, numeroDestino, e.clientX < mitad);
            }
            compasDestino.classList.remove('drop-izquierda', 'drop-derecha');
            actualizarNumerosCompases();
        }

        function actualizarNumerosCompases() {
            const compases = document.querySelectorAll('.compas');
            const imagenesScroll = document.getElementById('imagenes-scroll');
            const contenedoresImagen = Array.from(imagenesScroll.querySelectorAll('.imagen-compas'));

            compases.forEach((compas, index) => {
                const nuevoNumero = index + 1;
                const nombreCompasElement = compas.querySelector('.nombre-compas');
                // A√±adir verificaci√≥n para evitar error si el elemento no existe
                const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';

                // Actualizar n√∫mero del comp√°s
                const numeroCompasElement = compas.querySelector('.numero-compas');
                if (numeroCompasElement) {
                    numeroCompasElement.textContent = nuevoNumero;
                }

                // Buscar el contenedor de imagen correspondiente al comp√°s original
                const contenedorImagenAntiguo = contenedoresImagen.find(cont =>
                    compas.getAttribute('data-imagen-id') === cont.getAttribute('data-imagen-id')
                );

                if (contenedorImagenAntiguo) {
                    // Actualizar el ID y el n√∫mero mostrado
                    contenedorImagenAntiguo.id = `imagen-compas-${nuevoNumero}`;
                    const numeroLabel = contenedorImagenAntiguo.querySelector('.numero-compas');
                    if (numeroLabel) {
                        numeroLabel.innerHTML = `Comp√°s ${nuevoNumero} - <span class="nombre-imagen">${nombreCompas}</span>`;
                    }
                }
            });

            contadorCompases = compases.length;
            actualizarJSON();
        }

        function eliminarCompas() {
            if (contadorCompases > 0) {
                const partitura = document.getElementById('partitura');
                partitura.removeChild(partitura.lastChild);

                // Eliminar tambi√©n el contenedor de imagen
                const imagenesScroll = document.getElementById('imagenes-scroll');
                const ultimaImagen = document.getElementById(`imagen-compas-${contadorCompases}`);
                if (ultimaImagen) {
                    imagenesScroll.removeChild(ultimaImagen);
                }

                contadorCompases--;
                actualizarJSON();
            }

            cambiosPendientes = true;
        }
        function actualizarJSON() {
            const partitura = document.getElementById('partitura');
            const jsonOutput = document.getElementById('json-output');

            if (!partitura || !jsonOutput) return;

            const partituraData = {
                compases: []
            };

            partitura.querySelectorAll('.compas').forEach((compas, index) => {
                const numeroCompas = index + 1;
                const nombreCompasElement = compas.querySelector('.nombre-compas');
                const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';
                const lat = compas.getAttribute('data-lat');
                const lng = compas.getAttribute('data-lng');
                
                // Obtener el array de im√°genes
                let imagenes = compas.getAttribute('data-imagenes');
                imagenes = imagenes ? JSON.parse(imagenes) : [];
                
                // Convertir el array de objetos a un array de nombres
                const nombresImagenes = imagenes.map(img => img.nombre);

                const compasData = {
                    numero: numeroCompas,
                    nombre: nombreCompas,
                    imagenes: nombresImagenes, // Ahora es un array
                    ubicacion: lat && lng ? { lat: parseFloat(lat), lng: parseFloat(lng) } : null,
                    elementos: []
                };

                compas.querySelectorAll('.contenedor-acorde-letra').forEach(contenedor => {
                    const acordeSpan = contenedor.querySelector('.acorde span');
                    const letraSpan = contenedor.querySelector('.letra span');

                    compasData.elementos.push({
                        acorde: acordeSpan ? (acordeSpan.textContent === '%' ? '' : acordeSpan.textContent) : '',
                        letra: letraSpan ? letraSpan.textContent : ''
                    });
                });

                partituraData.compases.push(compasData);
            });

            jsonOutput.textContent = JSON.stringify(partituraData, null, 2);
            actualizarJSONSeleccionados();
            cambiosPendientes = true;
        }

        function actualizarJSONSeleccionados() {
            const jsonSeleccionados = document.getElementById('json-seleccionados');
            
            if (!jsonSeleccionados) return;

            if (compasesSeleccionados.size === 0) {
                jsonSeleccionados.textContent = JSON.stringify({ compases: [] }, null, 2);
                return;
            }

            const seleccionadosData = {
                compases: Array.from(compasesSeleccionados).map(compas => {
                    const numeroCompas = compas.querySelector('.numero-compas').textContent;
                    const nombreCompasElement = compas.querySelector('.nombre-compas');
                    const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';
                    const lat = compas.getAttribute('data-lat');
                    const lng = compas.getAttribute('data-lng');
                    const imagenId = compas.getAttribute('data-imagen-id');
                    
                    // Inicializar imagen como null por defecto
                    let nombreImagen = null;
                    
                    // Solo buscar el nombre de la imagen si existe un ID
                    if (imagenId) {
                        const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"]`);
                        if (contenedorImagen) {
                            const indiceImagen = contenedorImagen.querySelector('.indice-imagen');
                            if (indiceImagen) {
                                nombreImagen = indiceImagen.textContent;
                            }
                        }
                    }

                    const elementos = [];
                    compas.querySelectorAll('.contenedor-acorde-letra').forEach(contenedor => {
                        const acordeSpan = contenedor.querySelector('.acorde span');
                        const letraSpan = contenedor.querySelector('.letra span');

                        elementos.push({
                            acorde: acordeSpan ? (acordeSpan.textContent === '%' ? '' : acordeSpan.textContent) : '',
                            letra: letraSpan ? letraSpan.textContent : ''
                        });
                    });

                    let imagenes = compas.getAttribute('data-imagenes');
                    imagenes = imagenes ? JSON.parse(imagenes) : [];
                    const nombresImagenes = imagenes.map(img => img.nombre);

                    return {
                        numero: parseInt(numeroCompas),
                        nombre: nombreCompas,
                        imagenes: nombresImagenes, // Ahora es un array
                        ubicacion: lat && lng ? { lat: parseFloat(lat), lng: parseFloat(lng) } : null,
                        elementos: elementos
                    };
                })
            };

            jsonSeleccionados.textContent = JSON.stringify(seleccionadosData, null, 2);
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';

            // Crear array para la informaci√≥n de las im√°genes
            const imagesInfo = [];

            Array.from(files).forEach((file, index) => {
                // Crear el preview de la imagen (tu c√≥digo existente)
                const reader = new FileReader();
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';

                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imageContainer.appendChild(img);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'X';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = function () {
                        imageContainer.remove();
                    };
                    imageContainer.appendChild(deleteButton);
                };

                reader.readAsDataURL(file);
                previewContainer.appendChild(imageContainer);

                // Agregar la informaci√≥n de la imagen al array
                imagesInfo.push({
                    index: index,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type
                });
            });

            // Mostrar la informaci√≥n en formato JSON
            const imagesInfoElement = document.getElementById('images-info');
            imagesInfoElement.textContent = JSON.stringify(imagesInfo, null, 2);
        }

        // Agregar esta funci√≥n al final del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function reordenarImagenes(numeroOrigen, numeroDestino, antesDelDestino) {
            const imagenesScroll = document.getElementById('imagenes-scroll');
            const contenedorOrigen = document.getElementById(`imagen-compas-${numeroOrigen}`);
            const contenedorDestino = document.getElementById(`imagen-compas-${numeroDestino}`);

            if (contenedorOrigen && contenedorDestino) {
                if (antesDelDestino) {
                    imagenesScroll.insertBefore(contenedorOrigen, contenedorDestino);
                } else {
                    imagenesScroll.insertBefore(contenedorOrigen, contenedorDestino.nextSibling);
                }
            }
        }



        // Agregar esta nueva funci√≥n
        function seleccionarCompas(compas) {
            const ubicarBtn = document.getElementById('ubicar-btn');
            
            if (compasesSeleccionados.has(compas)) {
                // Deseleccionar si ya estaba seleccionado
                compasesSeleccionados.delete(compas);
                compas.classList.remove('seleccionado');
                const imagenVinculada = document.querySelector(`[data-imagen-id="${compas.getAttribute('data-imagen-id')}"].imagen-compas`);
                if (imagenVinculada) {
                    imagenVinculada.classList.remove('seleccionado');
                }
            } else {
                // Seleccionar el comp√°s
                compasesSeleccionados.add(compas);
                compas.classList.add('seleccionado');
                const imagenVinculada = document.querySelector(`[data-imagen-id="${compas.getAttribute('data-imagen-id')}"].imagen-compas`);
                if (imagenVinculada) {
                    imagenVinculada.classList.add('seleccionado');
                }
            }

            // Actualizar el estado del bot√≥n ubicar y el mapa
            if (compasesSeleccionados.size > 0) {
                ubicarBtn.style.display = 'block';
                
                // Si solo hay un comp√°s seleccionado, mostrar sus coordenadas en el mapa
                if (compasesSeleccionados.size === 1) {
                    const compasSeleccionado = Array.from(compasesSeleccionados)[0];
                    const lat = compasSeleccionado.getAttribute('data-lat');
                    const lng = compasSeleccionado.getAttribute('data-lng');
                    if (lat && lng) {
                        map.setView([lat, lng], map.getZoom());
                        if (marker) map.removeLayer(marker);
                        marker = L.marker([lat, lng]).addTo(map);
                    }
                }
            } else {
                ubicarBtn.style.display = 'none';
                if (marker) map.removeLayer(marker);
            }
        }

        // Modificar el event listener del body
        document.body.addEventListener('click', (e) => {
            const clickedCompas = e.target.closest('.compas');
            if (clickedCompas) {
                e.stopPropagation();
                seleccionarCompas(clickedCompas);
            }
        });

        // Agregar manejador para cuando la p√°gina se cierre
        window.addEventListener('beforeunload', (e) => {
            if (cambiosPendientes) {
                // Mostrar mensaje de confirmaci√≥n
                e.preventDefault();
                e.returnValue = ''; // Requerido para algunos navegadores
            }
        });

        function handleImageUpload(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result); // Devuelve una URL de datos (data URL)
                };
                
                reader.onerror = function(e) {
                    console.error('Error al leer el archivo:', e);
                    reject(e);
                };
                
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>

</html>