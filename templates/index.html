<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <link rel="icon" type="image/x-icon" href="/static/favicon.ico">
    <title>Editor de Partitura</title>
    <style>
        .partitura {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            padding: 20px;
            background-color: #fff;
            min-height: 200px;
            border: 1px solid #ccc;
        }

        .compas {
            min-width: 200px;
            height: auto;
            min-height: 120px;
            border: 2px solid #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            position: relative;
            cursor: pointer;
            padding: 20px 15px;
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        .controles {
            margin: 20px;
        }

        button {
            font-size: 20px;
            margin: 0 10px;
            padding: 5px 15px;
            cursor: pointer;
        }

        .numero-compas {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 12px;
            color: #666;
        }

        .acordes,
        .letras {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 10px;
            min-height: 50px;
            padding: 5px;
            width: 100%;
        }

        .contenedor-acorde-letra {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .acorde,
        .letra {
            min-width: 80px;
            width: auto;
            height: auto;
            min-height: 50px;
            padding: 5px 10px;
            border: 1px solid transparent;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            position: relative;
            transition: all 0.3s ease;
            background-color: white;
            word-break: break-word;
        }

        .letra {
            border: 1px dashed #ccc;
            /* Borde punteado para diferenciar */
            color: #666;
            /* Color m√°s suave para las letras */
        }

        .acorde.nuevo,
        .letra.nuevo {
            color: #666;
        }

        .acorde.escrito {
            color: #2ecc71;
        }

        .letra.escrito {
            color: #3498db;
            /* Color diferente para letras escritas */
        }

        .acorde.seleccionado,
        .letra.seleccionado {
            background-color: #3498db;
            color: white;
        }

        .acorde:hover .eliminar-acorde,
        .letra:hover .eliminar-letra {
            display: block;
        }

        .eliminar-acorde,
        .eliminar-letra,
        .eliminar-compas {
            display: none;
            position: absolute;
            top: -10px;
            right: -10px;
            background-color: red;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 14px;
            line-height: 20px;
            cursor: pointer;
            text-align: center;
            z-index: 10;
        }

        .compas:hover .eliminar-compas {
            display: block;
        }

        .acorde-input,
        .letra-input {
            min-width: 80px;
            width: auto;
            height: auto;
            min-height: 50px;
            font-size: 24px;
            text-align: center;
            border: 1px solid #999;
            padding: 5px 10px;
            box-sizing: border-box;
        }

        .agregar-acorde-btn {
            position: absolute;
            /* Cambiado a posici√≥n absoluta */
            right: -15px;
            /* Posicionado a la derecha */
            top: 50%;
            /* Centrado verticalmente */
            transform: translateY(-50%);
            /* Ajuste fino del centrado vertical */
            width: 30px;
            height: 30px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .agregar-acorde-btn:hover {
            background-color: #27ae60;
        }

        .compas.arrastrando,
        .acorde.arrastrando,
        .letra.arrastrando {
            opacity: 0.5;
            cursor: move;
        }

        .compas.drop-izquierda {
            border-left: 3px solid #3498db;
        }

        .compas.drop-derecha {
            border-right: 3px solid #3498db;
        }

        .acorde.drop-izquierda,
        .letra.drop-izquierda {
            border-left: 3px solid #3498db;
        }

        .acorde.drop-derecha,
        .letra.drop-derecha {
            border-right: 3px solid #3498db;
        }

        .acordes.drop-activo,
        .letras.drop-activo {
            background-color: #f0f9ff;
            border: 2px dashed #3498db;
        }

        .contenedor-compas {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            position: relative;
            /* A√±adido para posicionamiento relativo */
        }

        .json-output {
            margin: 20px;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        .json-container {
            margin: 20px;
        }

        .json-container button {
            margin-bottom: 10px;
        }

        /* Agregar al CSS existente */
        .container {
            display: flex;
            gap: 20px;
            padding: 20px;
            height: 100vh;
        }

        .imagenes-container {
            width: 300px;
            border-right: 1px solid #ccc;
            padding-right: 20px;
        }

        .imagenes-scroll {
            height: calc(100vh - 100px);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
        }

        .imagen-compas {
            position: relative;
            width: 100%;
            border: 1px solid #ccc;
            padding: 10px;
            background: #fff;
            border-radius: 4px;
        }

        .imagen-compas img {
            width: 100%;
            height: auto;
            display: block;
        }

        .imagen-compas .numero-compas {
            position: absolute;
            top: 5px;
            left: 5px;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 3px;
        }

        .imagen-upload {
            width: 100%;
            padding: 20px;
            border: 2px dashed #ccc;
            text-align: center;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .imagen-upload:hover {
            border-color: #3498db;
            background: #f7f9fc;
        }

        .eliminar-imagen {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            text-align: center;
            line-height: 20px;
            cursor: pointer;
        }

        #images-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }

        /* ... existing styles ... */
        .nombre-compas {
            position: absolute;
            top: 2px;
            right: 25px;
            /* Espacio para no solapar con el bot√≥n de eliminar */
            font-size: 12px;
            color: #666;
            cursor: pointer;
            padding: 2px 5px;
            border: 1px dashed transparent;
        }

        .nombre-compas:hover {
            border-color: #ccc;
        }

        .nombre-compas-input {
            position: absolute;
            top: 2px;
            right: 25px;
            font-size: 12px;
            padding: 2px 5px;
            border: 1px solid #999;
        }


        /* ... existing styles ... */
        .compas.seleccionado {
            background-color: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        .imagen-compas.seleccionado {
            background-color: rgba(33, 150, 243, 0.1);
            border: 2px solid #2196f3;
            box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
        }

        #map {
            height: 400px;
            width: 100%;
            margin: 20px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .map-container {
            position: relative;
            margin: 20px 0;
        }

        #ubicar-btn {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 16px;
            background-color: #2ecc71;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: none; /* Se mostrar√° cuando se seleccione un comp√°s */
        }

        #ubicar-btn:hover {
            background-color: #27ae60;
        }

        /* Agregar estos estilos */
        .json-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .json-column h4 {
            margin: 0 0 10px 0;
            color: #333;
        }

        .json-output {
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
            font-size: 14px;
        }

        .imagen-upload-options {
            display: flex;
            gap: 10px;
        }

        .url-input-container {
            display: flex;
            gap: 10px;
        }

        .url-input {
            width: 200px;
            padding: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }

        .url-submit {
            padding: 5px 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .toggle-json-btn {
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            padding: 5px 15px;
            margin: 0 10px;
        }

        .toggle-json-btn:hover {
            background-color: #45a049;
        }

        .json-container {
            display: none;
            margin: 20px 0;
            padding: 20px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
        }

        .clear-all-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 12px;
            cursor: pointer;
            opacity: 0.6;
            transition: opacity 0.3s;
        }

        .clear-all-btn:hover {
            opacity: 1;
        }

        /* Agregar estos estilos para la animaci√≥n de parpadeo */
        @keyframes parpadeo {
            0% { background-color: rgba(52, 152, 219, 0.1); }
            50% { background-color: rgba(52, 152, 219, 0.3); }
            100% { background-color: rgba(52, 152, 219, 0.1); }
        }

        .imagen-upload.parpadeando {
            animation: parpadeo 1.5s infinite;
            border-color: #3498db;
        }
    </style>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
</head>

<body>
    <div class="container">
        <!-- Nuevo contenedor para im√°genes -->
        <div class="imagenes-container">
            <h3>Im√°genes</h3>
            <div class="controles">
                <button onclick="agregarContenedorImagen()">+</button>
            </div>
            <div class="imagenes-scroll" id="imagenes-scroll">
                <!-- Las im√°genes se agregar√°n aqu√≠ din√°micamente -->
            </div>
        </div>

        <!-- Contenedor principal derecho -->
        <div class="main-content">
            <div class="controles">
                <button onclick="agregarCompas()">+</button>
                <button onclick="eliminarCompas()">-</button>
                <button onclick="toggleJSON()" class="toggle-json-btn">Mostrar JSON</button>
                <button onclick="clearAll()" class="clear-all-btn">Clear All</button>
            </div>
            <div class="partitura" id="partitura">
            </div>
            <div class="json-container" style="display: none;">
                <button onclick="toggleJSON()" class="toggle-json-btn">Mostrar JSON</button>
                <div class="json-grid">
                    <div class="json-column">
                        <h4>Partitura Completa</h4>
                        <div id="json-output" class="json-output"></div>
                    </div>
                    <div class="json-column">
                        <h4>Compases Seleccionados</h4>
                        <div id="json-seleccionados" class="json-output"></div>
                    </div>
                </div>
            </div>
            <div class="map-container">
                <div id="map"></div>
                <button id="ubicar-btn" style="display: none;">Ubicar</button>
            </div>
        </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Agregar esto al inicio del script, antes de las variables globales
        function toggleJSON() {
            const jsonContainer = document.querySelector('.json-container');
            const buttons = document.querySelectorAll('.toggle-json-btn');
            
            if (jsonContainer.style.display === 'none') {
                jsonContainer.style.display = 'block';
                buttons.forEach(button => button.textContent = 'Ocultar JSON');
                actualizarJSON();
            } else {
                jsonContainer.style.display = 'none';
                buttons.forEach(button => button.textContent = 'Mostrar JSON');
            }
        }

        function clearAll() {
            if (confirm('¬øEst√° seguro que desea eliminar todos los compases? Esta acci√≥n no se puede deshacer.')) {
                // Limpiar partitura
                const partitura = document.getElementById('partitura');
                partitura.innerHTML = '';
                
                // Limpiar im√°genes
                const imagenesScroll = document.getElementById('imagenes-scroll');
                imagenesScroll.innerHTML = '';
                
                // Reiniciar contadores
                contadorCompases = 0;
                contadorImagenes = 0;
                
                // Limpiar selecciones
                compasesSeleccionados.clear();
                compasSeleccionado = null;
                acordeSeleccionado = null;
                letraSeleccionada = null;
                
                // Limpiar marcadores del mapa
                markers.forEach(marker => map.removeLayer(marker));
                markers.clear();
                
                if (tempMarker) {
                    map.removeLayer(tempMarker);
                    tempMarker = null;
                }
                
                // Ocultar bot√≥n de ubicar
                const ubicarBtn = document.getElementById('ubicar-btn');
                if (ubicarBtn) {
                    ubicarBtn.style.display = 'none';
                }
                
                // Actualizar JSON
                actualizarJSON();
                
                // Marcar cambios pendientes
                cambiosPendientes = true;
            }
        }

        // Variables globales existentes
        let contadorCompases = 0;
        let acordeSeleccionado = null;
        let letraSeleccionada = null;
        let elementoArrastrado = null;
        let compasSeleccionado = null;
        let compasesSeleccionados = new Set();

        let map, markers = new Map();
        let currentCenter;

        // Agregar estas variables globales
        let ultimoEstadoJSON = '';
        let timerAutoguardado = null;
        let cambiosPendientes = false;

        // Agregar variable global para el marcador temporal
        let tempMarker = null;

        // Crear un icono rojo personalizado
        const redIcon = L.icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // Funci√≥n para comparar si hay cambios
        function hayCambios() {
            const estadoActual = generarJSONEstado();
            return estadoActual !== ultimoEstadoJSON;
        }

        // Funci√≥n para generar el estado actual en JSON
        function generarJSONEstado() {
            const partitura = document.getElementById('partitura');
            const estado = {
                compases: []
            };

            partitura.querySelectorAll('.compas').forEach((compas, index) => {
                const numeroCompas = index + 1;
                const nombreCompas = compas.querySelector('.nombre-compas')?.textContent || 'Sin t√≠tulo';
                const imagenId = compas.getAttribute('data-imagen-id');
                const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"] img`);
                
                estado.compases.push({
                    numero: numeroCompas,
                    nombre: nombreCompas,
                    imagen: contenedorImagen ? contenedorImagen.src : null,
                    lat: compas.getAttribute('data-lat'),
                    lng: compas.getAttribute('data-lng')
                });
            });

            return JSON.stringify(estado);
        }

        // Funci√≥n de autoguardado
        async function autoguardar() {
            if (!cambiosPendientes || !hayCambios() || guardandoCambios) {
                return;
            }

            try {
                guardandoCambios = true;
                const estado = generarJSONEstado();
                
                // Guardar en cookies de forma s√≠ncrona
                const maxLength = 4000;
                const chunks = Math.ceil(estado.length / maxLength);
                
                setCookie('estado_chunks', chunks, {
                    maxAge: 86400,
                    SameSite: 'Strict',
                    Secure: window.location.protocol === 'https:'
                });
                
                for (let i = 0; i < chunks; i++) {
                    const chunk = estado.substr(i * maxLength, maxLength);
                    setCookie(`estado_${i}`, chunk, {
                        maxAge: 86400,
                        SameSite: 'Strict',
                        Secure: window.location.protocol === 'https:'
                    });
                }
                
                ultimoEstadoJSON = estado;
                cambiosPendientes = false;
                
                // Actualizar visualizaci√≥n del JSON de forma s√≠ncrona
                const jsonOutput = document.getElementById('json-output');
                if (jsonOutput) {
                    jsonOutput.textContent = JSON.stringify(JSON.parse(estado), null, 2);
                }
                
            } catch (error) {
                console.error('Error durante el guardado final:', error);
            } finally {
                guardandoCambios = false;
            }
        }

        // Funci√≥n para iniciar el sistema de autoguardado
        function iniciarAutoguardado() {
            // Guardar estado inicial
            ultimoEstadoJSON = generarJSONEstado();
            
            // Configurar el timer de autoguardado
            timerAutoguardado = setInterval(async () => {
                try {
                    await autoguardar();
                } catch (error) {
                    console.error('Error en el ciclo de autoguardado:', error);
                }
            }, 2000);

            // Agregar listener para cambios en la partitura
            const partitura = document.getElementById('partitura');
            const observer = new MutationObserver(() => {
                cambiosPendientes = true;
            });

            observer.observe(partitura, {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Inicializar el mapa
            map = L.map('map').setView([40.416775, -3.703790], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            const ubicarBtn = document.getElementById('ubicar-btn');
            
            map.on('move', () => {
                currentCenter = map.getCenter();
                // Si hay un comp√°s seleccionado y estamos en modo ubicaci√≥n
                if (compasesSeleccionados.size === 1) {
                    // Si no existe el marcador temporal, cr√©alo
                    if (!tempMarker) {
                        tempMarker = L.marker(currentCenter, {icon: redIcon}).addTo(map);
                    } else {
                        // Si ya existe, actualiza su posici√≥n
                        tempMarker.setLatLng(currentCenter);
                    }
                }
            });

            ubicarBtn.addEventListener('click', () => {
                console.log(' Click en bot√≥n ubicar');
                if (compasSeleccionado && currentCenter) {
                    const lat = currentCenter.lat.toFixed(6);
                    const lng = currentCenter.lng.toFixed(6);

                    console.log('üìç Coordenadas actuales:', {
                        latitud: lat,
                        longitud: lng
                    });
                    
                    compasSeleccionado.setAttribute('data-lat', lat);
                    compasSeleccionado.setAttribute('data-lng', lng);
                    
                    // Eliminar el marcador temporal si existe
                    if (tempMarker) {
                        map.removeLayer(tempMarker);
                        tempMarker = null;
                    }

                    // Actualizar o crear el marcador permanente (azul)
                    const markerId = compasSeleccionado.getAttribute('data-marker-id');
                    if (markerId) {
                        if (markers.has(markerId)) {
                            markers.get(markerId).setLatLng([lat, lng]);
                        } else {
                            const newMarker = L.marker([lat, lng]).addTo(map);
                            markers.set(markerId, newMarker);
                        }
                    }

                    actualizarJSON();
                    console.log('‚úÖ JSON actualizado con las nuevas coordenadas');
                } else {
                    console.warn('‚ö†Ô∏è No hay comp√°s seleccionado o coordenadas no disponibles');
                }
            });

            // Configurar el observer aqu√≠
            const observer = new MutationObserver(() => {
                actualizarJSON();
            });

            observer.observe(document.getElementById('partitura'), {
                childList: true,
                subtree: true,
                characterData: true,
                attributes: true
            });

            iniciarAutoguardado();
        });

        function agregarCompas() {
            contadorCompases++;
            const partitura = document.getElementById('partitura');
            const nuevoCompas = document.createElement('div');
            nuevoCompas.className = 'compas';
            nuevoCompas.draggable = true;
            
            nuevoCompas.addEventListener('dragstart', dragStart);
            nuevoCompas.addEventListener('dragend', dragEnd);
            nuevoCompas.addEventListener('dragover', dragOver);
            nuevoCompas.addEventListener('drop', drop);

            const eliminarCompasBtn = document.createElement('div');
            eliminarCompasBtn.className = 'eliminar-compas';
            eliminarCompasBtn.textContent = '√ó';
            eliminarCompasBtn.onclick = (e) => {
                e.stopPropagation();
                partitura.removeChild(nuevoCompas);
                actualizarNumerosCompases();
            };

            const numeroCompas = document.createElement('div');
            numeroCompas.className = 'numero-compas';
            numeroCompas.textContent = contadorCompases;

            const nombreCompas = document.createElement('div');
            nombreCompas.className = 'nombre-compas';
            nombreCompas.textContent = 'Sin t√≠tulo';
            nombreCompas.onclick = function (e) {
                e.stopPropagation();
                const input = document.createElement('input');
                input.className = 'nombre-compas-input';
                input.value = nombreCompas.textContent;

                input.onblur = function () {
                    const nuevoNombre = input.value || 'Sin t√≠tulo';
                    nombreCompas.textContent = nuevoNombre;
                    nuevoCompas.replaceChild(nombreCompas, input);
                    actualizarJSON();
                };

                input.onkeypress = function (e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                };

                nuevoCompas.replaceChild(input, nombreCompas);
                input.focus();
            };

            const acordesDiv = document.createElement('div');
            acordesDiv.className = 'acordes';

            acordesDiv.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                acordesDiv.classList.add('drop-activo');
            });

            acordesDiv.addEventListener('dragleave', (e) => {
                acordesDiv.classList.remove('drop-activo');
            });

            acordesDiv.addEventListener('drop', (e) => {
                e.preventDefault();
                e.stopPropagation();
                acordesDiv.classList.remove('drop-activo');

                if (elementoArrastrado && elementoArrastrado.classList.contains('contenedor-acorde-letra')) {
                    const acordeDestino = e.target.closest('.contenedor-acorde-letra');
                    if (acordeDestino) {
                        const rect = acordeDestino.getBoundingClientRect();
                        const mitad = (rect.left + rect.right) / 2;
                        if (e.clientX < mitad) {
                            acordesDiv.insertBefore(elementoArrastrado, acordeDestino);
                        } else {
                            acordesDiv.insertBefore(elementoArrastrado, acordeDestino.nextSibling);
                        }
                    } else {
                        acordesDiv.appendChild(elementoArrastrado);
                    }
                }
            });

            const contenedorCompas = document.createElement('div');
            contenedorCompas.className = 'contenedor-compas';

            const agregarAcordeBtn = document.createElement('button');
            agregarAcordeBtn.className = 'agregar-acorde-btn';
            agregarAcordeBtn.textContent = '+';
            agregarAcordeBtn.onclick = (e) => {
                e.stopPropagation();
                agregarAcordeYLetra(acordesDiv);
            };

            agregarAcordeYLetra(acordesDiv);

            contenedorCompas.appendChild(acordesDiv);
            contenedorCompas.appendChild(agregarAcordeBtn);

            nuevoCompas.appendChild(eliminarCompasBtn);
            nuevoCompas.appendChild(numeroCompas);
            nuevoCompas.appendChild(nombreCompas);
            nuevoCompas.appendChild(contenedorCompas);
            partitura.appendChild(nuevoCompas);

            nuevoCompas.addEventListener('click', (e) => {
                e.stopPropagation();
                seleccionarCompas(nuevoCompas);
            });

            cambiosPendientes = true;
            
            // Retornar el elemento creado
            return nuevoCompas;
        }

        // Agregar variable global para contar im√°genes
        let contadorImagenes = 0;

        function agregarContenedorImagen() {
            const imagenesScroll = document.getElementById('imagenes-scroll');
            contadorImagenes++;
            const imagenId = `imagen-${contadorImagenes}`; 
            const nombreImagen = `Imagen ${contadorImagenes}`;
            
            const contenedor = document.createElement('div');
            contenedor.className = 'imagen-compas';
            contenedor.setAttribute('data-imagen-id', imagenId);
            contenedor.setAttribute('data-imagen-nombre', nombreImagen);

            const numeroLabel = document.createElement('div');
            numeroLabel.className = 'numero-compas';
            numeroLabel.innerHTML = `<span class="indice-imagen">${nombreImagen}</span>`;

            const eliminarBtn = document.createElement('div');
            eliminarBtn.className = 'eliminar-imagen';
            eliminarBtn.textContent = '√ó';
            eliminarBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                document.querySelectorAll('.compas').forEach(compas => {
                    let imagenes = compas.getAttribute('data-imagenes');
                    if (imagenes) {
                        imagenes = JSON.parse(imagenes);
                        imagenes = imagenes.filter(img => img.id !== imagenId);
                        compas.setAttribute('data-imagenes', JSON.stringify(imagenes));
                    }
                });
                contenedor.remove();
                actualizarJSON();
            };

            const uploadOptions = crearOpcionesDeImagen(contenedor);
            
            contenedor.appendChild(numeroLabel);
            contenedor.appendChild(uploadOptions);
            contenedor.appendChild(eliminarBtn);
            
            imagenesScroll.appendChild(contenedor);
            return contenedor;
        }

        // Funci√≥n auxiliar para crear las opciones de imagen
        function crearOpcionesDeImagen(contenedor) {
            const uploadOptions = document.createElement('div');
            uploadOptions.className = 'imagen-upload-options';
            
            // Opci√≥n para archivo local
            const uploadDiv = document.createElement('div');
            uploadDiv.className = 'imagen-upload';
            uploadDiv.textContent = 'Haga clic o arrastre una imagen aqu√≠';

            // Opci√≥n para URL con id y name √∫nicos
            const urlInput = document.createElement('div');
            urlInput.className = 'url-input-container';
            const inputId = `url-input-${Date.now()}`; // ID √∫nico
            urlInput.innerHTML = `
                <input 
                    type="text" 
                    placeholder="O pegue una URL de imagen" 
                    class="url-input"
                    id="${inputId}"
                    name="image-url"
                    autocomplete="off"
                >
                <div class="url-status"></div>
            `;

            // Input de archivo con id y name √∫nicos
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.jpg,.jpeg,.png,.svg';
            input.style.display = 'none';
            input.id = `file-input-${Date.now()}`; // ID √∫nico
            input.name = 'image-file';

            // Obtener referencias a los elementos
            const urlInputField = urlInput.querySelector('.url-input');
            const urlStatus = urlInput.querySelector('.url-status');

            // Funci√≥n mejorada para validar URLs
            function validarImagenUrl(url) {
                return new Promise((resolve, reject) => {
                    // Verificar si la URL tiene un formato v√°lido
                    try {
                        new URL(url);
                    } catch (e) {
                        reject(new Error('URL inv√°lida'));
                        return;
                    }

                    // Verificar si la URL termina en una extensi√≥n de imagen com√∫n
                    const extensionesValidas = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.svg'];
                    const urlLowerCase = url.toLowerCase();
                    const esExtensionValida = extensionesValidas.some(ext => urlLowerCase.endsWith(ext));
                    
                    if (!esExtensionValida) {
                        reject(new Error('La URL no parece ser una imagen'));
                        return;
                    }

                    // Intentar cargar la imagen
                    const img = new Image();
                    img.onload = () => resolve(url);
                    img.onerror = () => reject(new Error('No se pudo cargar la imagen'));
                    img.src = url;
                });
            }

            // Funci√≥n mejorada para verificar la URL
            const verificarUrl = async (url, urlStatus) => {
                if (!url.trim()) {
                    urlStatus.textContent = '';
                    urlStatus.className = 'url-status';
                    return;
                }

                urlStatus.textContent = 'Verificando...';
                urlStatus.className = 'url-status verificando';

                try {
                    await validarImagenUrl(url);
                    urlStatus.textContent = '‚úì URL v√°lida';
                    urlStatus.className = 'url-status valida';
                    return true;
                } catch (error) {
                    urlStatus.textContent = `‚úó ${error.message}`;
                    urlStatus.className = 'url-status invalida';
                    return false;
                }
            };

            // Manejar el pegado de URL
            urlInputField.addEventListener('paste', (e) => {
                setTimeout(async () => {
                    const url = urlInputField.value.trim();
                    if (url) {
                        const esValida = await verificarUrl(url, urlStatus);
                        if (esValida) {
                            try {
                                cargarImagen(url, contenedor, uploadOptions);
                            } catch (error) {
                                console.error('Error al cargar la imagen:', error);
                                urlStatus.textContent = '‚úó Error al cargar la imagen';
                                urlStatus.className = 'url-status invalida';
                            }
                        }
                    }
                }, 100);
            });

            // Manejar cuando el usuario sale del input
            urlInputField.addEventListener('blur', async () => {
                const url = urlInputField.value.trim();
                if (url) {
                    const esValida = await verificarUrl(url, urlStatus);
                    if (esValida) {
                        try {
                            cargarImagen(url, contenedor, uploadOptions);
                        } catch (error) {
                            console.error('Error al cargar la imagen:', error);
                            urlStatus.textContent = '‚úó Error al cargar la imagen';
                            urlStatus.className = 'url-status invalida';
                        }
                    }
                }
            });

            // Manejar la carga de archivo local
            uploadDiv.onclick = (e) => {
                e.preventDefault();
                input.click();
            };

            input.onchange = async function(e) {
                const file = e.target.files[0];
                if (file) {
                    try {
                        const dataUrl = await handleImageUpload(file);
                        cargarImagen(dataUrl, contenedor, uploadOptions);
                    } catch (error) {
                        console.error('Error al cargar la imagen:', error);
                        alert('Error al cargar la imagen');
                    }
                }
            };

            uploadOptions.appendChild(uploadDiv);
            uploadOptions.appendChild(urlInput);
            uploadOptions.appendChild(input);
            
            return uploadOptions;
        }

        // Funci√≥n auxiliar para cargar la imagen
        function cargarImagen(src, contenedor, elementoAReemplazar) {
            const img = document.createElement('img');
            img.src = src;
            img.style.width = '100%';  // Asegurar que la imagen se ajuste al contenedor
            img.style.height = 'auto';
            img.style.display = 'block';
            
            // Asignar la imagen a todos los compases seleccionados
            compasesSeleccionados.forEach(compas => {
                let imagenes = compas.getAttribute('data-imagenes');
                imagenes = imagenes ? JSON.parse(imagenes) : [];
                
                imagenes.push({
                    id: contenedor.getAttribute('data-imagen-id'),
                    nombre: contenedor.getAttribute('data-imagen-nombre'),
                    url: src  // Guardar la URL de la imagen
                });
                
                compas.setAttribute('data-imagenes', JSON.stringify(imagenes));
            });

            // Limpiar el contenedor y agregar la imagen
            if (elementoAReemplazar.parentNode) {
                // Eliminar las opciones de carga
                contenedor.removeChild(elementoAReemplazar);
                
                // Agregar la imagen
                contenedor.appendChild(img);
                
                // Agregar bot√≥n para cambiar la imagen
                const cambiarImagenBtn = document.createElement('button');
                cambiarImagenBtn.className = 'cambiar-imagen-btn';
                cambiarImagenBtn.textContent = 'Cambiar imagen';
                cambiarImagenBtn.onclick = (e) => {
                    e.stopPropagation();
                    // Recrear las opciones de carga
                    const nuevasOpciones = crearOpcionesDeImagen(contenedor);
                    contenedor.removeChild(img);
                    contenedor.removeChild(cambiarImagenBtn);
                    contenedor.appendChild(nuevasOpciones);
                };
                contenedor.appendChild(cambiarImagenBtn);
            }
            
            actualizarJSON();
        }

        function agregarAcordeYLetra(acordesDiv) {
            const contenedor = document.createElement('div');
            contenedor.className = 'contenedor-acorde-letra';
            contenedor.draggable = true;

            contenedor.addEventListener('dragstart', (e) => {
                elementoArrastrado = contenedor;
                contenedor.classList.add('arrastrando');
                e.stopPropagation();
            });

            contenedor.addEventListener('dragend', (e) => {
                contenedor.classList.remove('arrastrando');
                elementoArrastrado = null;
                document.querySelectorAll('.drop-activo').forEach(el => el.classList.remove('drop-activo'));
            });

            // Crear acorde
            const acorde = crearElementoEditable('acorde', '%');

            // Crear letra
            const letra = crearElementoEditable('letra', '');

            contenedor.appendChild(acorde);
            contenedor.appendChild(letra);
            acordesDiv.appendChild(contenedor);
        }

        function crearElementoEditable(tipo, textoInicial) {
            const elemento = document.createElement('div');
            elemento.className = `${tipo} nuevo`;

            const contenido = document.createElement('span');
            contenido.textContent = textoInicial;
            elemento.appendChild(contenido);

            const eliminarBtn = document.createElement('div');
            eliminarBtn.className = `eliminar-${tipo}`;
            eliminarBtn.textContent = '√ó';
            eliminarBtn.onclick = (e) => {
                e.stopPropagation();
                const contenedor = elemento.parentElement;
                const acordesDiv = contenedor.parentElement;
                acordesDiv.removeChild(contenedor);
                actualizarJSON();
            };

            elemento.addEventListener('click', function (e) {
                e.stopPropagation();
                if (tipo === 'acorde' && acordeSeleccionado) {
                    acordeSeleccionado.classList.remove('seleccionado');
                } else if (tipo === 'letra' && letraSeleccionada) {
                    letraSeleccionada.classList.remove('seleccionado');
                }

                elemento.classList.add('seleccionado');
                if (tipo === 'acorde') acordeSeleccionado = elemento;
                else letraSeleccionada = elemento;

                const input = document.createElement('input');
                input.className = `${tipo}-input`;
                input.value = contenido.textContent === '%' ? '' : contenido.textContent;

                input.addEventListener('blur', function () {
                    if (input.value.trim()) {
                        contenido.textContent = input.value.trim();
                        elemento.replaceChild(contenido, input);
                        elemento.classList.remove('nuevo');
                        elemento.classList.add('escrito');
                        if (!elemento.contains(eliminarBtn)) {
                            elemento.appendChild(eliminarBtn);
                        }
                    } else {
                        contenido.textContent = tipo === 'acorde' ? '%' : '';
                        elemento.replaceChild(contenido, input);
                        elemento.classList.add('nuevo');
                        elemento.classList.remove('escrito');
                    }
                    elemento.classList.remove('seleccionado');
                    if (tipo === 'acorde') acordeSeleccionado = null;
                    else letraSeleccionada = null;
                    actualizarJSON();
                });

                input.addEventListener('keypress', function (e) {
                    if (e.key === 'Enter') {
                        input.blur();
                    }
                });

                if (elemento.contains(contenido)) {
                    elemento.replaceChild(input, contenido);
                } else {
                    elemento.innerHTML = '';
                    elemento.appendChild(input);
                }
                input.focus();
            });

            return elemento;
        }

        function dragStart(e) {
            // Asegurarse de que elementoArrastrado siempre sea un array
            if (!this.classList.contains('seleccionado')) {
                elementoArrastrado = [this];
            } else {
                // Obtener todos los compases seleccionados en su orden actual en el DOM
                const todosLosCompases = Array.from(this.parentNode.children);
                elementoArrastrado = Array.from(compasesSeleccionados)
                    .sort((a, b) => {
                        return todosLosCompases.indexOf(a) - todosLosCompases.indexOf(b);
                    });
            }
            
            elementoArrastrado.forEach(compas => {
                compas.classList.add('arrastrando');
            });
            
            e.dataTransfer.setData('type', 'compas');
        }

        function dragEnd(e) {
            // Verificar que elementoArrastrado existe y es un array
            if (elementoArrastrado && Array.isArray(elementoArrastrado)) {
                // Remover clase de arrastre de todos los elementos
                elementoArrastrado.forEach(compas => {
                    compas.classList.remove('arrastrando');
                });
            } else if (elementoArrastrado) {
                // Si elementoArrastrado es un √∫nico elemento
                elementoArrastrado.classList.remove('arrastrando');
            }
            
            elementoArrastrado = null;
            document.querySelectorAll('.drop-activo').forEach(el => el.classList.remove('drop-activo'));
        }

        function dragOver(e) {
            e.preventDefault();
            const compasDestino = this;
            
            // Verificar que elementoArrastrado es un array y existe
            if (elementoArrastrado && Array.isArray(elementoArrastrado) && 
                !elementoArrastrado.includes(compasDestino)) {
                const rect = compasDestino.getBoundingClientRect();
                const mitad = (rect.left + rect.right) / 2;
                
                compasDestino.classList.remove('drop-izquierda', 'drop-derecha');
                if (e.clientX < mitad) {
                    compasDestino.classList.add('drop-izquierda');
                } else {
                    compasDestino.classList.add('drop-derecha');
                }
            }
        }

        function drop(e) {
            e.preventDefault();
            const compasDestino = this;
            
            // Verificar que elementoArrastrado es un array y existe
            if (elementoArrastrado && Array.isArray(elementoArrastrado) && 
                !elementoArrastrado.includes(compasDestino)) {
                const rect = compasDestino.getBoundingClientRect();
                const mitad = (rect.left + rect.right) / 2;
                const insertarAntes = e.clientX < mitad;
                
                // Encontrar el primer y √∫ltimo comp√°s del bloque seleccionado
                const primerCompas = elementoArrastrado[0];
                
                // Insertar todo el bloque en la nueva posici√≥n
                if (insertarAntes) {
                    elementoArrastrado.forEach(compas => {
                        compasDestino.parentNode.insertBefore(compas, compasDestino);
                    });
                } else {
                    // Para insertar despu√©s, insertamos en orden inverso despu√©s del destino
                    elementoArrastrado.reverse().forEach(compas => {
                        compasDestino.parentNode.insertBefore(compas, compasDestino.nextSibling);
                    });
                }
                
                // Mover las im√°genes asociadas manteniendo el mismo orden
                const imagenesScroll = document.getElementById('imagenes-scroll');
                const imagenDestino = document.querySelector(`[data-imagen-id="${compasDestino.getAttribute('data-imagen-id')}"]`);
                
                if (imagenDestino) {
                    const imagenesAMover = elementoArrastrado.map(compas => {
                        return document.querySelector(`[data-imagen-id="${compas.getAttribute('data-imagen-id')}"]`);
                    }).filter(img => img); // Filtrar nulls
                    
                    if (insertarAntes) {
                        imagenesAMover.forEach(imagen => {
                            imagenesScroll.insertBefore(imagen, imagenDestino);
                        });
                    } else {
                        imagenesAMover.reverse().forEach(imagen => {
                            imagenesScroll.insertBefore(imagen, imagenDestino.nextSibling);
                        });
                    }
                }
            }
            
            compasDestino.classList.remove('drop-izquierda', 'drop-derecha');
            actualizarNumerosCompases();
        }

        function actualizarNumerosCompases() {
            const compases = document.querySelectorAll('.compas');
            const imagenesScroll = document.getElementById('imagenes-scroll');
            const contenedoresImagen = Array.from(imagenesScroll.querySelectorAll('.imagen-compas'));

            compases.forEach((compas, index) => {
                const nuevoNumero = index + 1;
                const nombreCompasElement = compas.querySelector('.nombre-compas');
                // A√±adir verificaci√≥n para evitar error si el elemento no existe
                const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';

                // Actualizar n√∫mero del comp√°s
                const numeroCompasElement = compas.querySelector('.numero-compas');
                if (numeroCompasElement) {
                    numeroCompasElement.textContent = nuevoNumero;
                }

                // Buscar el contenedor de imagen correspondiente al comp√°s original
                const contenedorImagenAntiguo = contenedoresImagen.find(cont =>
                    compas.getAttribute('data-imagen-id') === cont.getAttribute('data-imagen-id')
                );

                if (contenedorImagenAntiguo) {
                    // Actualizar el ID y el n√∫mero mostrado
                    contenedorImagenAntiguo.id = `imagen-compas-${nuevoNumero}`;
                    const numeroLabel = contenedorImagenAntiguo.querySelector('.numero-compas');
                    if (numeroLabel) {
                        numeroLabel.innerHTML = `Comp√°s ${nuevoNumero} - <span class="nombre-imagen">${nombreCompas}</span>`;
                    }
                }
            });

            contadorCompases = compases.length;
            actualizarJSON();
        }

        function eliminarCompas() {
            if (contadorCompases > 0) {
                const partitura = document.getElementById('partitura');
                partitura.removeChild(partitura.lastChild);

                // Eliminar tambi√©n el contenedor de imagen
                const imagenesScroll = document.getElementById('imagenes-scroll');
                const ultimaImagen = document.getElementById(`imagen-compas-${contadorCompases}`);
                if (ultimaImagen) {
                    imagenesScroll.removeChild(ultimaImagen);
                }

                contadorCompases--;
                actualizarJSON();
            }

            cambiosPendientes = true;
        }
        function actualizarJSON() {
            const partitura = document.getElementById('partitura');
            const jsonOutput = document.getElementById('json-output');

            if (!partitura || !jsonOutput) return;

            const partituraData = {
                compases: []
            };

            partitura.querySelectorAll('.compas').forEach((compas, index) => {
                const numeroCompas = index + 1;
                const nombreCompasElement = compas.querySelector('.nombre-compas');
                const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';
                const lat = compas.getAttribute('data-lat');
                const lng = compas.getAttribute('data-lng');
                
                // Obtener el array de im√°genes
                let imagenes = compas.getAttribute('data-imagenes');
                imagenes = imagenes ? JSON.parse(imagenes) : [];
                
                // Convertir el array de objetos a un array de nombres
                const nombresImagenes = imagenes.map(img => img.nombre);

                const compasData = {
                    numero: numeroCompas,
                    nombre: nombreCompas,
                    imagenes: nombresImagenes, // Ahora es un array
                    ubicacion: lat && lng ? { lat: parseFloat(lat), lng: parseFloat(lng) } : null,
                    elementos: []
                };

                compas.querySelectorAll('.contenedor-acorde-letra').forEach(contenedor => {
                    const acordeSpan = contenedor.querySelector('.acorde span');
                    const letraSpan = contenedor.querySelector('.letra span');

                    compasData.elementos.push({
                        acorde: acordeSpan ? (acordeSpan.textContent === '%' ? '' : acordeSpan.textContent) : '',
                        letra: letraSpan ? letraSpan.textContent : ''
                    });
                });

                partituraData.compases.push(compasData);
            });

            jsonOutput.textContent = JSON.stringify(partituraData, null, 2);
            actualizarJSONSeleccionados();
            cambiosPendientes = true;
        }

        function actualizarJSONSeleccionados() {
            const jsonSeleccionados = document.getElementById('json-seleccionados');
            
            if (!jsonSeleccionados) return;

            if (compasesSeleccionados.size === 0) {
                jsonSeleccionados.textContent = JSON.stringify({ compases: [] }, null, 2);
                return;
            }

            const seleccionadosData = {
                compases: Array.from(compasesSeleccionados).map(compas => {
                    const numeroCompas = compas.querySelector('.numero-compas').textContent;
                    const nombreCompasElement = compas.querySelector('.nombre-compas');
                    const nombreCompas = nombreCompasElement ? nombreCompasElement.textContent : 'Sin t√≠tulo';
                    const lat = compas.getAttribute('data-lat');
                    const lng = compas.getAttribute('data-lng');
                    const imagenId = compas.getAttribute('data-imagen-id');
                    
                    // Inicializar imagen como null por defecto
                    let nombreImagen = null;
                    
                    // Solo buscar el nombre de la imagen si existe un ID
                    if (imagenId) {
                        const contenedorImagen = document.querySelector(`[data-imagen-id="${imagenId}"]`);
                        if (contenedorImagen) {
                            const indiceImagen = contenedorImagen.querySelector('.indice-imagen');
                            if (indiceImagen) {
                                nombreImagen = indiceImagen.textContent;
                            }
                        }
                    }

                    const elementos = [];
                    compas.querySelectorAll('.contenedor-acorde-letra').forEach(contenedor => {
                        const acordeSpan = contenedor.querySelector('.acorde span');
                        const letraSpan = contenedor.querySelector('.letra span');

                        elementos.push({
                            acorde: acordeSpan ? (acordeSpan.textContent === '%' ? '' : acordeSpan.textContent) : '',
                            letra: letraSpan ? letraSpan.textContent : ''
                        });
                    });

                    let imagenes = compas.getAttribute('data-imagenes');
                    imagenes = imagenes ? JSON.parse(imagenes) : [];
                    const nombresImagenes = imagenes.map(img => img.nombre);

                    return {
                        numero: parseInt(numeroCompas),
                        nombre: nombreCompas,
                        imagenes: nombresImagenes, // Ahora es un array
                        ubicacion: lat && lng ? { lat: parseFloat(lat), lng: parseFloat(lng) } : null,
                        elementos: elementos
                    };
                })
            };

            jsonSeleccionados.textContent = JSON.stringify(seleccionadosData, null, 2);
        }

        function handleFileSelect(event) {
            const files = event.target.files;
            const previewContainer = document.getElementById('images-preview');
            previewContainer.innerHTML = '';

            // Crear array para la informaci√≥n de las im√°genes
            const imagesInfo = [];

            Array.from(files).forEach((file, index) => {
                // Crear el preview de la imagen (tu c√≥digo existente)
                const reader = new FileReader();
                const imageContainer = document.createElement('div');
                imageContainer.className = 'image-container';

                reader.onload = function (e) {
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    imageContainer.appendChild(img);

                    const deleteButton = document.createElement('button');
                    deleteButton.textContent = 'X';
                    deleteButton.className = 'delete-button';
                    deleteButton.onclick = function () {
                        imageContainer.remove();
                    };
                    imageContainer.appendChild(deleteButton);
                };

                reader.readAsDataURL(file);
                previewContainer.appendChild(imageContainer);

                // Agregar la informaci√≥n de la imagen al array
                imagesInfo.push({
                    index: index,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: file.type
                });
            });

            // Mostrar la informaci√≥n en formato JSON
            const imagesInfoElement = document.getElementById('images-info');
            imagesInfoElement.textContent = JSON.stringify(imagesInfo, null, 2);
        }

        // Agregar esta funci√≥n al final del archivo
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function reordenarImagenes(numeroOrigen, numeroDestino, antesDelDestino) {
            const imagenesScroll = document.getElementById('imagenes-scroll');
            const contenedorOrigen = document.getElementById(`imagen-compas-${numeroOrigen}`);
            const contenedorDestino = document.getElementById(`imagen-compas-${numeroDestino}`);

            if (contenedorOrigen && contenedorDestino) {
                if (antesDelDestino) {
                    imagenesScroll.insertBefore(contenedorOrigen, contenedorDestino);
                } else {
                    imagenesScroll.insertBefore(contenedorOrigen, contenedorDestino.nextSibling);
                }
            }
        }



        // Agregar esta nueva funci√≥n
        function seleccionarCompas(compas) {
            const ubicarBtn = document.getElementById('ubicar-btn');
            
            // Si hab√≠a un marcador temporal, eliminarlo
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            // Actualizar la variable global compasSeleccionado
            compasSeleccionado = compas;
            
            // Obtener las im√°genes asociadas al comp√°s
            let imagenes = compas.getAttribute('data-imagenes');
            imagenes = imagenes ? JSON.parse(imagenes) : [];
            
            if (compasesSeleccionados.has(compas)) {
                // Si ya est√° seleccionado, lo deseleccionamos
                compasesSeleccionados.delete(compas);
                compas.classList.remove('seleccionado');
                
                // Deseleccionar todas las im√°genes vinculadas
                imagenes.forEach(imagen => {
                    const contenedorImagen = document.querySelector(`[data-imagen-id="${imagen.id}"]`);
                    if (contenedorImagen) {
                        contenedorImagen.classList.remove('seleccionado');
                    }
                });
                
                // Eliminar el marcador correspondiente
                const markerId = compas.getAttribute('data-marker-id');
                if (markerId && markers.has(markerId)) {
                    map.removeLayer(markers.get(markerId));
                    markers.delete(markerId);
                }
            } else {
                // Si no est√° seleccionado, lo a√±adimos a la selecci√≥n
                compasesSeleccionados.add(compas);
                compas.classList.add('seleccionado');
                
                // Seleccionar todas las im√°genes vinculadas
                imagenes.forEach(imagen => {
                    const contenedorImagen = document.querySelector(`[data-imagen-id="${imagen.id}"]`);
                    if (contenedorImagen) {
                        contenedorImagen.classList.add('seleccionado');
                        
                        // Hacer scroll hasta la imagen seleccionada
                        const imagenesScroll = document.getElementById('imagenes-scroll');
                        if (imagenesScroll) {
                            contenedorImagen.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                        }
                    }
                });
            }

            // Actualizar marcadores y vista del mapa
            if (compasesSeleccionados.size > 0) {
                ubicarBtn.style.display = 'block';
                actualizarMarcadoresYVista();
            } else {
                ubicarBtn.style.display = 'none';
                // Limpiar todos los marcadores
                markers.forEach(marker => map.removeLayer(marker));
                markers.clear();
            }
            
            actualizarJSONSeleccionados();
        }

        // Modificar actualizarMarcadoresYVista para manejar el marcador temporal
        function actualizarMarcadoresYVista() {
            // Si hab√≠a un marcador temporal, eliminarlo
            if (tempMarker) {
                map.removeLayer(tempMarker);
                tempMarker = null;
            }

            const bounds = L.latLngBounds();
            let hayMarcadores = false;

            // Limpiar marcadores existentes
            markers.forEach(marker => map.removeLayer(marker));
            markers.clear();

            // Crear marcadores para cada comp√°s seleccionado
            compasesSeleccionados.forEach(compas => {
                const lat = compas.getAttribute('data-lat');
                const lng = compas.getAttribute('data-lng');
                
                if (lat && lng) {
                    const latLng = [parseFloat(lat), parseFloat(lng)];
                    const markerId = `marker-${compas.getAttribute('data-marker-id') || Date.now()}`;
                    compas.setAttribute('data-marker-id', markerId);
                    
                    // Crear marcador con popup mostrando el nombre del comp√°s
                    const marker = L.marker(latLng).bindPopup(
                        `Comp√°s ${compas.querySelector('.numero-compas').textContent} - ${compas.querySelector('.nombre-compas').textContent}`
                    );
                    markers.set(markerId, marker);
                    marker.addTo(map);
                    
                    bounds.extend(latLng);
                    hayMarcadores = true;
                }
            });

            // Ajustar la vista del mapa
            if (hayMarcadores) {
                map.fitBounds(bounds, {
                    padding: [50, 50], // A√±adir padding para mejor visualizaci√≥n
                    maxZoom: 15 // Limitar el zoom m√°ximo
                });
            } else {
                // Si no hay marcadores con coordenadas, mantener la vista actual
                const center = map.getCenter();
                const marker = L.marker(center);
                markers.set('temp', marker);
                marker.addTo(map);
            }
        }

        // Simplificar el event listener
        document.body.addEventListener('click', (e) => {
            const clickedCompas = e.target.closest('.compas');
            if (clickedCompas) {
                e.stopPropagation();
                seleccionarCompas(clickedCompas);
            }
        });

        // Agregar manejador para cuando la p√°gina se cierre
        let guardandoCambios = false;

        window.addEventListener('beforeunload', (e) => {
            if (cambiosPendientes && !guardandoCambios) {
                try {
                    // Realizar guardado s√≠ncrono
                    guardandoCambios = true;
                    
                    // Generar y guardar el estado inmediatamente
                    const estado = generarJSONEstado();
                    
                    // Guardar en cookies de forma s√≠ncrona
                    const maxLength = 4000;
                    const chunks = Math.ceil(estado.length / maxLength);
                    
                    setCookie('estado_chunks', chunks, {
                        maxAge: 86400,
                        SameSite: 'Strict',
                        Secure: window.location.protocol === 'https:'
                    });
                    
                    for (let i = 0; i < chunks; i++) {
                        const chunk = estado.substr(i * maxLength, maxLength);
                        setCookie(`estado_${i}`, chunk, {
                            maxAge: 86400,
                            SameSite: 'Strict',
                            Secure: window.location.protocol === 'https:'
                        });
                    }
                    
                    ultimoEstadoJSON = estado;
                    cambiosPendientes = false;
                    
                    // Actualizar visualizaci√≥n del JSON de forma s√≠ncrona
                    const jsonOutput = document.getElementById('json-output');
                    if (jsonOutput) {
                        jsonOutput.textContent = JSON.stringify(JSON.parse(estado), null, 2);
                    }
                    
                } catch (error) {
                    console.error('Error durante el guardado final:', error);
                } finally {
                    guardandoCambios = false;
                }
                
                // Mostrar mensaje de confirmaci√≥n
                e.preventDefault();
                e.returnValue = '¬øEst√° seguro de que desea salir? Hay cambios sin guardar.';
                return e.returnValue;
            }
        });

        function handleImageUpload(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    resolve(e.target.result); // Devuelve una URL de datos (data URL)
                };
                
                reader.onerror = function(e) {
                    console.error('Error al leer el archivo:', e);
                    reject(e);
                };
                
                reader.readAsDataURL(file);
            });
        }

        // Agregar estas funciones para manejar cookies de forma segura
        function setCookie(name, value, options = {}) {
            options = {
                path: '/',
                // Agregar opciones de seguridad por defecto
                SameSite: 'Strict',
                Secure: window.location.protocol === 'https:',
                ...options
            };

            let cookieString = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;

            for (let optionKey in options) {
                const optionValue = options[optionKey];
                cookieString += `; ${optionKey}`;
                
                if (optionValue !== true) {
                    cookieString += `=${optionValue}`;
                }
            }

            document.cookie = cookieString;
        }

        function getCookie(name) {
            const matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
            ));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        // Funci√≥n para guardar el estado en cookies
        function guardarEstadoEnCookies() {
            if (guardandoCambios) return;
            
            try {
                guardandoCambios = true;
                const estado = generarJSONEstado();
                
                // Dividir el estado en chunks si es muy grande
                const maxLength = 4000; // Tama√±o m√°ximo recomendado para una cookie
                const chunks = Math.ceil(estado.length / maxLength);
                
                // Guardar el n√∫mero de chunks
                setCookie('estado_chunks', chunks, {
                    maxAge: 86400, // 24 horas
                    SameSite: 'Strict',
                    Secure: window.location.protocol === 'https:'
                });
                
                // Guardar cada chunk
                for (let i = 0; i < chunks; i++) {
                    const chunk = estado.substr(i * maxLength, maxLength);
                    setCookie(`estado_${i}`, chunk, {
                        maxAge: 86400,
                        SameSite: 'Strict',
                        Secure: window.location.protocol === 'https:'
                    });
                }
                
                console.log('‚úÖ Estado guardado en cookies:', new Date().toLocaleTimeString());
            } catch (error) {
                console.error('Error al guardar en cookies:', error);
            } finally {
                guardandoCambios = false;
            }
        }

        // Funci√≥n para cargar el estado desde cookies
        function cargarEstadoDesdeCookies() {
            try {
                const chunks = parseInt(getCookie('estado_chunks')) || 0;
                if (chunks === 0) return null;
                
                let estado = '';
                for (let i = 0; i < chunks; i++) {
                    const chunk = getCookie(`estado_${i}`);
                    if (chunk) {
                        estado += chunk;
                    }
                }
                
                return estado ? JSON.parse(estado) : null;
            } catch (error) {
                console.error('Error al cargar desde cookies:', error);
                return null;
            }
        }

        // Modificar el inicializador para usar las cookies
        document.addEventListener('DOMContentLoaded', () => {
            // ... c√≥digo existente ...

            // Intentar cargar el estado guardado
            const estadoGuardado = cargarEstadoDesdeCookies();
            if (estadoGuardado) {
                try {
                    // Aqu√≠ implementar la l√≥gica para restaurar el estado
                    restaurarEstado(estadoGuardado);
                    console.log('‚úÖ Estado restaurado desde cookies');
                } catch (error) {
                    console.error('Error al restaurar el estado:', error);
                }
            }

            // Configurar el autoguardado
            setInterval(() => {
                if (cambiosPendientes) {
                    guardarEstadoEnCookies();
                }
            }, 30000); // Guardar cada 30 segundos si hay cambios
        });

        // Funci√≥n para restaurar el estado
        function restaurarEstado(estado) {
            if (!estado || !estado.compases) return;
            
            // Limpiar el estado actual
            const partitura = document.getElementById('partitura');
            if (!partitura) return;
            
            partitura.innerHTML = '';
            
            // Restaurar cada comp√°s
            estado.compases.forEach(compasData => {
                const compas = agregarCompas();
                if (!compas) return; // Verificar que el comp√°s se cre√≥ correctamente
                
                // Restaurar nombre
                const nombreCompas = compas.querySelector('.nombre-compas');
                if (nombreCompas && compasData.nombre) {
                    nombreCompas.textContent = compasData.nombre;
                }
                
                // Restaurar ubicaci√≥n
                if (compasData.ubicacion) {
                    compas.setAttribute('data-lat', compasData.ubicacion.lat);
                    compas.setAttribute('data-lng', compasData.ubicacion.lng);
                }
                
                // Restaurar elementos
                if (compasData.elementos && compasData.elementos.length > 0) {
                    const acordesDiv = compas.querySelector('.acordes');
                    if (acordesDiv) {
                        acordesDiv.innerHTML = ''; // Limpiar elementos por defecto
                        
                        compasData.elementos.forEach(elemento => {
                            agregarAcordeYLetra(acordesDiv, elemento.acorde, elemento.letra);
                        });
                    }
                }
            });
            
            actualizarNumerosCompases();
        }

        // Asegurarse de que el CSS para la selecci√≥n de im√°genes est√© definido
        const style = document.createElement('style');
        style.textContent = `
            .imagen-compas.seleccionado {
                background-color: rgba(33, 150, 243, 0.1);
                border: 2px solid #2196f3;
                box-shadow: 0 0 5px rgba(33, 150, 243, 0.3);
            }
        `;
        document.head.appendChild(style);
    </script>
</body>

</html>